
<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="css/index.css" />
<title>MessageWrite</title>
</head>
<body>
<aside class="sidebar" aria-hidden="true">
  <div class="side-btn" id="btnHome">üè†<div class="side-badge" id="totalUnread">0</div></div>
  <div class="side-btn" id="btnCreate">‚ûï</div>
  <div class="side-btn" id="btnSettings">‚öôÔ∏è</div>
</aside>
<main class="chat" role="main">
  <div class="chat-header">
    <div class="header-left">
      <button class="icon-btn" id="toggleRoomsBtn">‚ò∞</button>
      <div style="display:flex;flex-direction:column;min-width:0">
        <div class="chat-title" id="roomTitle">–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–º–Ω–∞—Ç—É</div>
        <div class="chat-sub" id="roomSub">–ö–æ–¥ –Ω–µ –≤—ã–±—Ä–∞–Ω</div>
      </div>
       <img src="logo.png" alt="–õ–æ–≥–æ" class="header-logo">
    </div>
    <div style="display:flex;align-items:center;gap:8px">
      <div class="chip" id="shareCode" style="display:none;cursor:pointer;font-size:13px;padding:6px 10px;border-radius:10px;background:#1f2123;border:1px solid rgba(255,255,255,0.02)"></div>
    </div>
  </div>

  <div class="messages" id="messages" aria-live="polite"></div>

  <div class="composer" id="composer">
  <div class="chat-input-container">
    <div id="replyBar" class="reply-bar hidden">
      <span id="replyText"></span>
      <button id="cancelReply">‚úï</button>
    </div>
<button class="btnsk" id="attachBtn" title="–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å">üìé</button>
    <input class="input input-msg" id="msgInput" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ... (Enter ‚Äî –æ—Ç–ø—Ä–∞–≤–∏—Ç—å)">
    
    <button class="send" id="sendBtn" title="–û—Ç–ø—Ä–∞–≤–∏—Ç—å" aria-label="Send">
      <svg viewBox="0 0 24 24" width="22" height="22" fill="white">
        <path d="M2 21l21-9L2 3v7l15 2-15 2z"/>
      </svg>
    </button>
    <input type="file" id="filePicker" accept="image/*,audio/*" hidden>
  </div>
</div>


</main>

<section class="list" id="desktopList">
  <div class="list-header">
    <div class="field">
      <input class="input" id="nickname" placeholder="–í–∞—à –Ω–∏–∫ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: –ì–æ—Å—Ç—å)" style="flex:1">
      <button class="btn" id="saveNick">OK</button>
    </div>
    <div class="field">
      <input class="input bubububebebe" id="roomNameInput" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–Ω–∞—Ç—ã" style="flex:1">
      <input class="input bubububebebe" id="roomAvatarInput" placeholder="URL –∞–≤–∞—Ç–∞—Ä–∫–∏" style="flex:1">
      <button class="btn bubububebebe" id="saveRoomMeta">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>
    
    <div class="field">
      <input class="input" id="joinCode" placeholder="–ö–æ–¥ –∫–æ–º–Ω–∞—Ç—ã: ABC123" style="text-transform:uppercase;flex:1">
      <button class="btn" id="joinBtn">–í–æ–π—Ç–∏</button>
     
    </div>
  </div>
  <div class="rooms" id="rooms"></div>
</section>

<div class="rooms-overlay-backdrop" id="roomsBackdrop" aria-hidden="true"></div>
<section class="rooms-overlay" id="roomsOverlay" aria-hidden="true">
  <div style="padding:12px;border-bottom:1px solid rgba(255,255,255,0.03);display:flex;gap:8px;align-items:center">
    <button class="btn" id="closeRoomsMobile">‚Üê</button>
    <div style="flex:1;font-weight:700">–ú–µ–Ω—é</div>
  </div>
  <div style="padding:12px;display:flex;flex-direction:column;gap:10px">
    <div class="field">
      <input class="input bubububebebe" id="nickname_mobile" placeholder="–ù–∏–∫" style="flex:1">
      <button class="btn bubububebebe" id="saveNick_mobile">OK</button>
    </div>
    <div class="field">
      <div class="container-with-buttons">
      <input class="input" id="roomNameInput_m" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–Ω–∞—Ç—ã" style="flex:1">
      <input class="input" id="roomAvatarInput_m" placeholder="URL –∞–≤–∞—Ç–∞—Ä–∫–∏" style="flex:1">
      </div>
      <button class="btn" id="saveRoomMeta_m">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>
    <div class="field">
      <input class="input" id="joinCode_mobile" placeholder="–ö–æ–¥ –∫–æ–º–Ω–∞—Ç—ã: ABC123" style="text-transform:uppercase;flex:1">
      <div class="container-with-buttons">
  <button class="btn" id="joinBtn">–í–æ–π—Ç–∏</button>
  
  <button class="btn" id="createBtn">–°–æ–∑–¥–∞—Ç—å</button>

</div>

    </div>
    <div class="rooms" id="roomsMobileList" style="padding:0"></div>
  </div>
</section>

<script type="module">
/* ============================== Firebase init ============================== */
import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-auth.js";
import { getFirestore, doc, setDoc, getDoc, serverTimestamp, collection, addDoc, query, orderBy, onSnapshot, limit, runTransaction, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-firestore.js";
import { getStorage } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-storage.js";

const firebaseConfig = {
  apiKey: "AIzaSyBtcsiDCvGMBHoNKd7CxrS9w6zG0wnNzIc",
  authDomain: "messagecr-1e301.firebaseapp.com",
  projectId: "messagecr-1e301",
  storageBucket: "messagecr-1e301.appspot.com",
  messagingSenderId: "498943600919",
  appId: "1:498943600919:web:b0cc23f1f4a91fac52af52",
  measurementId: "G-7LT8E14VWG"
};

const app = getApps().length ? getApps()[0] : initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);

console.log('Firebase initialized', { projectId: firebaseConfig.projectId });

/* ============================== DOM refs ============================== */
const roomsEl = document.getElementById('rooms');
const roomsMobileList = document.getElementById('roomsMobileList');
const roomsOverlay = document.getElementById('roomsOverlay');
const roomsBackdrop = document.getElementById('roomsBackdrop');
const toggleRoomsBtn = document.getElementById('toggleRoomsBtn');
const closeRoomsMobile = document.getElementById('closeRoomsMobile');
const roomTitle = document.getElementById('roomTitle');
const roomSub = document.getElementById('roomSub');
const shareCode = document.getElementById('shareCode');
const messagesEl = document.getElementById('messages');
const msgInput = document.getElementById('msgInput');
const sendBtn = document.getElementById('sendBtn');
const filePicker = document.getElementById('filePicker');
const attachBtn = document.getElementById('attachBtn');
const joinCodeInput = document.getElementById('joinCode');
const joinCodeMobileInput = document.getElementById('joinCode_mobile');
const nicknameInput = document.getElementById('nickname');
const saveNickBtn = document.getElementById('saveNick');
const nicknameInputMobile = document.getElementById('nickname_mobile');
const saveNickBtnMobile = document.getElementById('saveNick_mobile');
const createBtn = document.getElementById('createBtn');
const createBtnMobile = document.getElementById('createBtn_mobile');
const totalUnreadEl = document.getElementById('totalUnread');
const roomNameInput = document.getElementById('roomNameInput');
const roomAvatarInput = document.getElementById('roomAvatarInput');
const saveRoomMeta = document.getElementById('saveRoomMeta');
const roomNameInput_m = document.getElementById('roomNameInput_m');
const roomAvatarInput_m = document.getElementById('roomAvatarInput_m');
const saveRoomMeta_m = document.getElementById('saveRoomMeta_m');

/* ====== —ç–ª–µ–º–µ–Ω—Ç—ã reply bar (–¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –≤ —Ä–∞–∑–º–µ—Ç–∫–µ) ====== */
const replyBar = document.getElementById('replyBar');
const replyText = document.getElementById('replyText');
const cancelReply = document.getElementById('cancelReply');

/* ============================== State ============================== */
let user = null;
let nickname = localStorage.getItem('crm_nick') || '–ì–æ—Å—Ç—å';
let currentRoom = null;
let unsubMessages = null;
let myRooms = JSON.parse(localStorage.getItem('crm_myRooms') || '[]');
const roomWatchers = {};
let replyTarget = null; // ID —Å–æ–æ–±—â–µ–Ω–∏—è, –Ω–∞ –∫–æ—Ç–æ—Ä–æ–µ –æ—Ç–≤–µ—á–∞–µ–º

if (nicknameInput) nicknameInput.value = nickname;
if (nicknameInputMobile) nicknameInputMobile.value = nickname;

/* ============================== Utils ============================== */
function isValidRoomCode(code){ return /^[A-HJ-NP-Z2-9]{6}$/.test(code); }
function randCode(len=6){
  const alphabet='ABCDEFGHJKMNPQRSTUVWXYZ23456789';
  let out=''; crypto.getRandomValues(new Uint32Array(len)).forEach(n=> out+=alphabet[n%alphabet.length]);
  return out;
}
function escapeHtml(s){ if(s === 0) return '0'; if(!s && s!==0) return ''; return String(s).replace(/[&<>\"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m])); }
function fmtTime(ts){ try{ const d = new Date(ts); return d.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}); }catch(e){ return ''; } }
function persistMyRooms(){ try{ localStorage.setItem('crm_myRooms', JSON.stringify(myRooms)); }catch(e){} }

/* ============================== Reply helpers ============================== */
function setReplyTarget(messageId, previewStr){
  replyTarget = messageId;
  if(replyText){
    const s = (previewStr || '').trim();
    replyText.textContent = s.length>80 ? s.slice(0,80)+'‚Ä¶' : s;
  }
  replyBar && replyBar.classList.remove('hidden');
}
function clearReplyTarget(){
  replyTarget = null;
  replyBar && replyBar.classList.add('hidden');
}
cancelReply && cancelReply.addEventListener('click', clearReplyTarget);

/* –ø—Ä–æ–∫—Ä—É—Ç–∏—Ç—å/–ø–æ–¥—Å–≤–µ—Ç–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ ID */
function scrollToMessage(messageId){
  if(!messagesEl) return;
  const tgt = messagesEl.querySelector(`.bubble.message[data-id="${CSS.escape(messageId)}"]`);
  if(!tgt) return;
  tgt.classList.add('ping');
  tgt.scrollIntoView({behavior:'smooth', block:'center'});
  setTimeout(()=> tgt.classList.remove('ping'), 1200);
}

/* —Å–æ–±—Ä–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –ø—Ä–µ–≤—å—é –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ Firestore */
function buildReplyPayloadFromDOM(messageId){
  const el = messagesEl?.querySelector(`.bubble.message[data-id="${CSS.escape(messageId)}"]`);
  if(!el) return null;
  const txt = el.querySelector('.message-text')?.textContent || '';
  const author = el.querySelector('.meta-name')?.textContent || '–°–æ–æ–±—â–µ–Ω–∏–µ';
  return {
    id: messageId,
    text: String(txt).slice(0, 500),
    name: String(author).slice(0, 60)
  };
}

/* ============================== Room watchers ============================== */
function ensureRoomWatcher(code){
  if(roomWatchers[code]) return;
  try{
    const qy = query(collection(db,'rooms',code,'messages'), orderBy('t','desc'), limit(1));
    const unsub = onSnapshot(qy, (snap) => {
      snap.forEach(d => {
        const m = d.data();
        const room = myRooms.find(r => r.code === code);
        if(!room) return;
        const msgTs = m.t && typeof m.t.toMillis === 'function' ? m.t.toMillis() : Date.now();
        if(currentRoom === code){ room.lastSeen = msgTs; room.lastMsg = msgTs; persistMyRooms(); return; }
        if(m.uid !== user?.uid && (!room.lastSeen || msgTs > room.lastSeen)){
          room.unreadCount = (room.unreadCount || 0) + 1;
          room.lastMsg = msgTs;
          persistMyRooms(); renderRoomsList();
        }
      });
    }, err => { console.error('roomWatcher onSnapshot error', err); });
    roomWatchers[code] = unsub;
  }catch(e){ console.error('ensureRoomWatcher error', e); }
}
function stopAllWatchers(){ Object.keys(roomWatchers).forEach(k=>{ try{ roomWatchers[k](); }catch(e){ console.error(e) } }); }

/* ============================== Rooms list render ============================== */
function renderRoomsList(){
  const total = myRooms.reduce((s,r)=> s + (r.unreadCount||0), 0);
  if(totalUnreadEl){ if(total>0){ totalUnreadEl.style.display='flex'; totalUnreadEl.textContent = total>99?'99+':String(total); } else totalUnreadEl.style.display='none'; }
  if(roomsEl) roomsEl.innerHTML='';
  myRooms.forEach(room=>{
    ensureRoomWatcher(room.code);
    const div = document.createElement('div');
    div.className = 'room-item' + (currentRoom===room.code?' active':'');
    div.innerHTML = `
      <div class="room-avatar">${room.avatar?`<img src="${escapeHtml(room.avatar)}">`:escapeHtml((room.name||room.code).slice(0,2).toUpperCase())}</div>
      <div style="flex:1">
        <div class="room-title">${escapeHtml(room.name||('–ö–æ–º–Ω–∞—Ç–∞ '+room.code))}</div>
        <div class="room-sub">–ö–æ–¥: ${escapeHtml(room.code)}</div>
      </div>
      ${room.unreadCount?`<button class="leave-btn" data-code="${escapeHtml(room.code)}">${room.unreadCount>99?'99+':room.unreadCount}</button>`:`<button class="leave-btn" data-code="${escapeHtml(room.code)}">‚úï</button>`}
    `;
    div.querySelector('.room-avatar').onclick = ()=> openRoom(room.code, room.name || ('–ö–æ–º–Ω–∞—Ç–∞ '+room.code));
    div.onclick = (e)=>{ if(e.target && e.target.classList && e.target.classList.contains('leave-btn')) return; openRoom(room.code, room.name || ('–ö–æ–º–Ω–∞—Ç–∞ '+room.code)); };
    roomsEl && roomsEl.appendChild(div);
    const leaveBtn = div.querySelector('.leave-btn');
    leaveBtn.onclick = (ev)=>{ ev.stopPropagation(); removeFromMyRooms(leaveBtn.dataset.code); };
  });

  if(roomsMobileList){
    roomsMobileList.innerHTML='';
    myRooms.forEach(room=>{
      const div = document.createElement('div');
      div.className = 'room-item' + (currentRoom===room.code?' active':'');
      div.style.marginBottom='6px';
      div.innerHTML = `
        <div class="room-avatar">${room.avatar?`<img src="${escapeHtml(room.avatar)}">`:escapeHtml((room.name||room.code).slice(0,2).toUpperCase())}</div>
        <div style="flex:1">
          <div class="room-title">${escapeHtml(room.name||('–ö–æ–º–Ω–∞—Ç–∞ '+room.code))}</div>
          <div class="room-sub">–ö–æ–¥: ${escapeHtml(room.code)}</div>
        </div>
        <button class="leave-btn" data-code="${escapeHtml(room.code)}">‚úï</button>
      `;
      div.onclick = (e)=>{ if(e.target && e.target.classList && e.target.classList.contains('leave-btn')) return; openRoom(room.code, room.name || ('–ö–æ–º–Ω–∞—Ç–∞ '+room.code)); closeRoomsOverlay(); };
      roomsMobileList.appendChild(div);
      const leaveBtn = div.querySelector('.leave-btn');
      leaveBtn.onclick = (ev)=>{ ev.stopPropagation(); removeFromMyRooms(leaveBtn.dataset.code); };
    });
  }
}

async function removeFromMyRooms(code){
  myRooms = myRooms.filter(r=> r.code !== code);
  if(roomWatchers[code]){ try{ roomWatchers[code](); }catch(e){ console.error(e) } delete roomWatchers[code]; }
  persistMyRooms(); renderRoomsList();
  if(currentRoom === code){
    currentRoom = null; if(messagesEl) messagesEl.innerHTML=''; if(roomTitle) roomTitle.textContent='–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–º–Ω–∞—Ç—É'; if(roomSub) roomSub.textContent='–ö–æ–¥ –Ω–µ –≤—ã–±—Ä–∞–Ω'; if(shareCode) shareCode.style.display='none';
    if(unsubMessages){ unsubMessages(); unsubMessages=null; }
  }
}
async function addToMyRooms(code,name,avatar){
  if(!myRooms.find(r=> r.code===code)){ myRooms.push({ code, name, avatar:avatar||'', unreadCount:0, lastSeen: Date.now() }); persistMyRooms(); renderRoomsList(); }
}

/* ============================== Create / Join ============================== */
async function createRoomFlow(){
  if(!user){ alert('–í—ã –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã'); return; }
  const code = randCode();
  const roomRef = doc(db,'rooms',code);
  try{
    await setDoc(roomRef, { createdAt: serverTimestamp(), name: '–ö–æ–º–Ω–∞—Ç–∞ '+code, active:true, creator:user.uid, avatar:'' });
    await addDoc(collection(db,'rooms',code,'messages'), { t: serverTimestamp(), uid: user.uid, name: nickname, text: `üëã ${nickname} —Å–æ–∑–¥–∞–ª(–∞) –∫–æ–º–Ω–∞—Ç—É`, sys:true });
    await addToMyRooms(code, '–ö–æ–º–Ω–∞—Ç–∞ '+code,'');
    openRoom(code,'–ö–æ–º–Ω–∞—Ç–∞ '+code);
  }catch(e){
    console.error('createRoomFlow error', e);
    alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É: ' + (e.message||e.code||'unknown'));
  }
}

async function joinRoomByCode(code){
  try{
    const roomRef = doc(db, 'rooms', code);
    const snap = await getDoc(roomRef);
    if(!snap.exists()) { alert('–ö–æ–º–Ω–∞—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ (–ª–∏–±–æ –µ—ë –Ω–µ—Ç, –ª–∏–±–æ —É –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ —á–∏—Ç–∞—Ç—å).'); return; }
    const data = snap.data();
    await addToMyRooms(code, data.name || ('–ö–æ–º–Ω–∞—Ç–∞ '+code), data.avatar||'');
    openRoom(code, data.name || ('–ö–æ–º–Ω–∞—Ç–∞ '+code));
  }catch(e){
    console.error('joinRoomByCode error', e);
    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–∏: ' + (e.message||e.code||'unknown'));
  }
}

/* ============================== Header ============================== */
function updateRoomHeader(roomObj){
  if(!roomTitle || !roomSub) return;
  const newTitle = roomObj.name || ('–ö–æ–º–Ω–∞—Ç–∞ ' + currentRoom);
  roomTitle.textContent = newTitle;
  roomSub.textContent = '–ö–æ–¥: ' + currentRoom;

  const headerLogo = document.querySelector('.header-logo');
  if(headerLogo){
    if(roomObj.avatar && roomObj.avatar.trim() !== ''){
      headerLogo.src = roomObj.avatar;
      headerLogo.style.display = 'inline-block';
    } else {
      headerLogo.style.display = 'none';
    }
  }
}

/* ============================== Open room / messages stream ============================== */
function openRoom(code,name){
  currentRoom = code;

  if(roomSub) roomSub.textContent = '–ö–æ–¥: ' + code;
  if(shareCode){
    shareCode.style.display='inline-block';
    shareCode.textContent = '–ü–æ–¥–µ–ª–∏—Ç—å—Å—è –∫–æ–¥–æ–º: ' + code;
    shareCode.onclick = ()=> navigator.clipboard?.writeText(code).then(()=>{ const prev = shareCode.textContent; shareCode.textContent='–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!'; setTimeout(()=>shareCode.textContent = prev,1200); }).catch(()=>{});
  }

  const roomObj = myRooms.find(r=> r.code === code);
  if(roomObj){
    roomObj.unreadCount = 0;
    persistMyRooms();
    renderRoomsList();
    if(roomNameInput) roomNameInput.value = roomObj.name || '';
    if(roomAvatarInput) roomAvatarInput.value = roomObj.avatar || '';
    if(roomNameInput_m) roomNameInput_m.value = roomObj.name || '';
    if(roomAvatarInput_m) roomAvatarInput_m.value = roomObj.avatar || '';
    updateRoomHeader(roomObj);
  } else {
    updateRoomHeader({ name: name || ('–ö–æ–º–Ω–∞—Ç–∞ ' + code), avatar: '' });
  }

  if(unsubMessages){ unsubMessages(); unsubMessages=null; }
  try{
    const qMsgs = query(collection(db, 'rooms', code, 'messages'), orderBy('t','asc'));
    unsubMessages = onSnapshot(qMsgs, (snap)=>{
      if(messagesEl) messagesEl.innerHTML='';
      snap.forEach(d => renderMessage(d.id, d.data()));
      requestAnimationFrame(()=> { if(messagesEl) messagesEl.scrollTo({ top: messagesEl.scrollHeight, behavior: 'smooth' }); });
      const lastDoc = snap.docs[snap.docs.length-1];
      if(lastDoc){
        const m = lastDoc.data();
        const ts = m.t && typeof m.t.toMillis === 'function' ? m.t.toMillis() : Date.now();
        const r = myRooms.find(rr => rr.code === code);
        if(r){ r.lastSeen = ts; r.lastMsg = ts; persistMyRooms(); renderRoomsList(); }
      }
    }, err => { console.error('onSnapshot messages error', err); });
  }catch(e){ console.error('openRoom subscribe error', e); }
}

/* ============================== Render message (with reply) ============================== */
function renderMessage(id,m){
  if(!messagesEl) return;

  if(m.sys){
    const wrap = document.createElement('div');
    wrap.className='bubble system';
    wrap.style.alignSelf='center'; wrap.style.background='transparent'; wrap.style.boxShadow='none'; wrap.style.color='var(--muted)';
    wrap.textContent = m.text || '';
    messagesEl.appendChild(wrap);
    requestAnimationFrame(()=> wrap.classList.add('show'));
    return;
  }

  const wrap = document.createElement('div');
  const mine = (m.uid === user?.uid);
  wrap.className = 'bubble message ' + (mine ? 'from-me' : 'from-other');
  wrap.dataset.id = id;

  const meEmoji = m.reactionsBy && user?.uid ? m.reactionsBy[user.uid] : null;
  const timeText = m.t ? fmtTime((m.t && typeof m.t.toMillis === 'function')?m.t.toMillis():Date.now()) : '';
  const nameText = mine? '–í—ã' : (m.name ? escapeHtml(m.name) : '–ì–æ—Å—Ç—å');

  /* –∫–Ω–æ–ø–∫–∏ –º–µ–Ω—é (–¥–æ–±–∞–≤–∏–ª "reply") */
  const menuHtml = `<button class="msg-menu" data-id="${id}">‚ãÆ</button>
    <div class="actions" id="actions-${id}">
      <button data-act="reply" data-id="${id}">‚Ü©Ô∏è –û—Ç–≤–µ—Ç–∏—Ç—å</button>
      ${mine?`<button data-act="edit" data-id="${id}">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>`:''}
      ${mine?`<button data-act="delete" data-id="${id}">üóë –£–¥–∞–ª–∏—Ç—å</button>`:''}
      <button data-act="react" data-id="${id}">üòä –†–µ–∞–∫—Ü–∏—è</button>
    </div>`;

  const rx = m.reactions || {};
  const rxHtml = Object.entries(rx).filter(([e,c])=>c>0).map(([e,c])=>`<div class="react-chip ${meEmoji===e?'me':''}" data-emo="${e}" data-id="${id}"><span>${e}</span><span>${c}</span></div>`).join('');
  const picker = `<div class="picker" id="picker-${id}">
    <span data-emo="üëç" data-id="${id}">üëç</span>
    <span data-emo="‚ù§Ô∏è" data-id="${id}">‚ù§Ô∏è</span>
    <span data-emo="üòÇ" data-id="${id}">üòÇ</span>
    <span data-emo="üî•" data-id="${id}">üî•</span>
    <span data-emo="üëè" data-id="${id}">üëè</span>
    <span data-emo="üòÆ" data-id="${id}">üòÆ</span>
    <span data-emo="üëé" data-id="${id}">üëé</span>
    <span data-emo="ü§Æ" data-id="${id}">ü§Æ</span>
    <span data-emo="ü§°" data-id="${id}">ü§°</span>
  </div>`;

  const textHTML = m.text ? `<div class="message-text">${escapeHtml(m.text)}</div>` : `<div class="message-text"></div>`;
  const mediaHTML = m.url ? `<div class="media">${ m.type?.startsWith('audio') ? `<audio controls src="${m.url}"></audio>` : `<img src="${m.url}" alt>` }</div>` : '';

let replyHTML = '';
  if (m.reply && m.reply.name && m.reply.text) {
    replyHTML = `
      <div class="reply-preview" data-reply-id="${escapeHtml(m.reply.id)}">
        <div class="reply-author">${escapeHtml(m.reply.name)}</div>
        <div class="reply-snippet">${escapeHtml(m.reply.text)}</div>
      </div>
    `;
  }

  wrap.innerHTML = `
  <div class="message-header">
    <div class="meta-name">${nameText}</div>
    ${menuHtml}
  </div>
  ${replyHTML}
  ${textHTML}
  ${mediaHTML}
  <div class="reactions-row">${rxHtml}</div>
  ${picker}
`;


  if(timeText){
    const timeDiv = document.createElement('div');
    timeDiv.className = 'meta-time';
    timeDiv.textContent = timeText;
    wrap.appendChild(timeDiv);
  }

  messagesEl.appendChild(wrap);

  /* –∫–ª–∏–∫ –ø–æ –ø—Ä–µ–≤—å—é –æ—Ç–≤–µ—Ç–∞ ‚Äî —Å–∫—Ä–æ–ª–ª –∫ –∏—Å—Ö–æ–¥–Ω–æ–º—É —Å–æ–æ–±—â–µ–Ω–∏—é */
  const replyQuote = wrap.querySelector('.reply-quote');
  if(replyQuote){
    replyQuote.addEventListener('click', (e)=>{
      const rid = replyQuote.getAttribute('data-reply-id');
      if(rid) scrollToMessage(rid);
    });
  }

  /* –º–µ–Ω—é */
  const menuBtn = wrap.querySelector('.msg-menu');
  if(menuBtn){
    const actions = wrap.querySelector('#actions-'+menuBtn.dataset.id);
    menuBtn.onclick = (e)=>{ e.stopPropagation(); document.querySelectorAll('.actions').forEach(a=>a.classList.remove('open')); actions.classList.toggle('open'); };
    wrap.addEventListener('click', ()=> { document.querySelectorAll('.actions').forEach(a=>a.classList.remove('open')); });
    actions.querySelectorAll('button').forEach(b=>{
      b.onclick = async (ev)=>{
        ev.stopPropagation();
        const act = b.dataset.act; const mid = b.dataset.id;
        if(act==='react'){ togglePicker(mid); }
        if(act==='edit'){ editMessage(mid); }
        if(act==='delete'){ deleteMessage(mid); }
        if(act==='reply'){
          const msgTextEl = wrap.querySelector('.message-text');
          const preview = msgTextEl ? (msgTextEl.textContent || '') : '';
          setReplyTarget(mid, preview);
          msgInput?.focus();
        }
        actions.classList.remove('open');
      };
    });
  }

  /* —Ä–µ–∞–∫—Ü–∏–∏ */
  wrap.querySelectorAll('.react-chip').forEach(ch=>{
    ch.onclick = ()=> addOrToggleReaction(id, ch.dataset.emo);
  });
  wrap.querySelectorAll('#picker-'+id+' span').forEach(sp=>{
    sp.onclick = ()=>{ addOrToggleReaction(id, sp.dataset.emo); togglePicker(id,false); };
  });

  /* –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é –ø–æ –¥–æ–ª–≥–æ–º—É —Ç–∞–ø—É/–ü–ö–ú */
  wrap.addEventListener('contextmenu', (e)=>{ e.preventDefault(); const actions = wrap.querySelector('.actions'); if(actions) actions.classList.add('open'); });

  /* —Å–≤–∞–π–ø –≤–ø—Ä–∞–≤–æ ‚Äî —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å replyTarget (–º–æ–±–∏–ª—å–Ω—ã–π –∂–µ—Å—Ç) */
  let touchStartX = 0, touchCurrentX = 0, pressTimer = null;
  wrap.addEventListener('touchstart', (e)=>{
    touchStartX = e.touches[0].clientX;
    touchCurrentX = touchStartX;
    wrap.style.transition = '';
    pressTimer = setTimeout(()=>{ const actions = wrap.querySelector('.actions'); if(actions) actions.classList.add('open'); }, 450);
  }, {passive:true});

  wrap.addEventListener('touchmove', (e)=>{
    touchCurrentX = e.touches[0].clientX;
    let diffX = touchCurrentX - touchStartX;
    if(diffX > 0){
      wrap.style.transform = `translateX(${diffX}px)`;
      if(diffX > 50) wrap.classList.add('swipe-active'); else wrap.classList.remove('swipe-active');
    }
    if(Math.abs(touchCurrentX - touchStartX) > 10 && pressTimer){ clearTimeout(pressTimer); pressTimer = null; }
  }, {passive:true});

  wrap.addEventListener('touchend', (e)=>{
    clearTimeout(pressTimer); pressTimer = null;
    let diffX = touchCurrentX - touchStartX;
    wrap.style.transition = 'transform 0.25s ease';
    wrap.style.transform = 'translateX(0)';
    if(diffX > 50){
      const msgTextEl = wrap.querySelector('.message-text');
      const preview = msgTextEl ? (msgTextEl.textContent || '') : '';
      setReplyTarget(id, preview);
    }
    wrap.classList.remove('swipe-active');
  }, {passive:true});

  requestAnimationFrame(()=> wrap.classList.add('show'));
}

/* ============================== Reactions / pickers ============================== */
function togglePicker(id,force){
  const el = document.getElementById('picker-'+id);
  if(!el) return;
  document.querySelectorAll('.picker').forEach(p=>{ if(p!==el) p.classList.remove('open'); });
  if(typeof force==='boolean'){ el.classList.toggle('open', force); return; }
  el.classList.toggle('open');
}

/* ============================== Send text (with reply) ============================== */
sendBtn && (sendBtn.onclick = sendText);
msgInput && msgInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); sendText(); } });

async function sendText(){
  if(!currentRoom){ alert('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –∫–æ–º–Ω–∞—Ç—É'); return; }
  if(!user){ alert('–í—ã –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ Anonymous auth –≤ Firebase Console.'); console.error('sendText: no user'); return; }
  const text = msgInput.value.trim();
  const f = msgInput._pendingFile || null;
  if(!text && !f){ return; }
  if(f){
    alert('–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤ –ø–æ–∫–∞ –æ—Ç–∫–ª—é—á–µ–Ω–∞: —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ');
    msgInput._pendingFile = null;
  }

  /* –µ—Å–ª–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω replyTarget ‚Äî —Å–æ–±–µ—Ä—ë–º –ø—Ä–µ–≤—å—é –∏–∑ DOM */
  let replyPayload = null;
  if(replyTarget){
    replyPayload = buildReplyPayloadFromDOM(replyTarget);
  }

  if(text){
    try{
      await addDoc(collection(db, 'rooms', currentRoom, 'messages'), {
        t: serverTimestamp(),
        uid: user?.uid || null,
        name: nickname,
        text,
        reactions:{},
        reactionsBy:{},
        reply: replyPayload || null
      });
      msgInput.value = '';
      clearReplyTarget();
    }catch(e){
      console.error('sendText error:', e);
      alert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: ' + (e.message || e.code || 'unknown'));
    }
  }
}

/* ============================== Attach (stub) ============================== */
attachBtn && (attachBtn.onclick = ()=> filePicker.click());
filePicker && (filePicker.onchange = (e)=> { const f = e.target.files?.[0]; if(f){ msgInput._pendingFile = f; } filePicker.value=''; });

/* ============================== Edit/Delete ============================== */
async function editMessage(id){
  try{
    const ref = doc(db,'rooms',currentRoom,'messages',id);
    const snap = await getDoc(ref);
    const old = snap.exists()? (snap.data().text||'') : '';
    const txt = prompt('–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å', old);
    if(txt!==null){ await updateDoc(ref,{ text: String(txt).slice(0,5000), edited:true }); }
  }catch(e){ console.error('editMessage error', e); alert('–ù–µ—Ç –ø—Ä–∞–≤ –Ω–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ'); }
}
async function deleteMessage(id){
  try{
    const ref = doc(db,'rooms',currentRoom,'messages',id);
    await deleteDoc(ref);
  }catch(e){ console.error('deleteMessage error', e); alert('–ù–µ—Ç –ø—Ä–∞–≤ –Ω–∞ —É–¥–∞–ª–µ–Ω–∏–µ'); }
}

/* ============================== Reactions tx ============================== */
async function addOrToggleReaction(id,emoji){
  const msgRef = doc(db,'rooms',currentRoom,'messages',id);
  try{
    await runTransaction(db, async (tx)=>{
      const snap = await tx.get(msgRef);
      if(!snap.exists()) return;
      const data = snap.data();
      const by = Object.assign({}, data.reactionsBy||{});
      const counts = Object.assign({}, data.reactions||{});
      const prev = by[user.uid] || null;
      if(prev === emoji){
        if(counts[emoji]) counts[emoji] = Math.max(0, counts[emoji]-1);
        delete by[user.uid];
      } else {
        if(prev && counts[prev]) counts[prev] = Math.max(0, counts[prev]-1);
        by[user.uid] = emoji;
        counts[emoji] = (counts[emoji]||0)+1;
      }
      tx.update(msgRef,{ reactions: counts, reactionsBy: by });
    });
  }catch(e){ console.error('addOrToggleReaction error', e); }
}

/* ============================== Overlay / UI misc ============================== */
toggleRoomsBtn && (toggleRoomsBtn.onclick = ()=> openRoomsOverlay());
closeRoomsMobile && (closeRoomsMobile.onclick = ()=> closeRoomsOverlay());
roomsBackdrop && (roomsBackdrop.onclick = ()=> closeRoomsOverlay());
function openRoomsOverlay(){ roomsOverlay && roomsOverlay.classList.add('open'); roomsBackdrop && roomsBackdrop.classList.add('show'); roomsOverlay && roomsOverlay.setAttribute('aria-hidden','false'); roomsBackdrop && roomsBackdrop.setAttribute('aria-hidden','false'); renderRoomsList(); }
function closeRoomsOverlay(){ roomsOverlay && roomsOverlay.classList.remove('open'); roomsBackdrop && roomsBackdrop.classList.remove('show'); roomsOverlay && roomsOverlay.setAttribute('aria-hidden','true'); roomsBackdrop && roomsBackdrop.setAttribute('aria-hidden','true'); }

/* ============================== Load my rooms from Firestore ============================== */
async function loadMyRoomsFromFirestore(){
  if(!user) return;
  try{
    const userDoc = doc(db, 'userRooms', user.uid);
    const snap = await getDoc(userDoc);
    if(!snap.exists()) return;
    const data = snap.data();
    if(Array.isArray(data.rooms)){
      myRooms = data.rooms.map(r=>({ code: r.code, name: r.name || ('–ö–æ–º–Ω–∞—Ç–∞ '+r.code), avatar: r.avatar||'', unreadCount: r.unreadCount||0, lastSeen: r.lastSeen||0 }));
      persistMyRooms(); renderRoomsList();
    }
  }catch(err){ console.error('loadMyRoomsFromFirestore error', err); }
}

/* ============================== Save room meta ============================== */
saveRoomMeta && (saveRoomMeta.onclick = ()=> saveRoomMetaAll());
saveRoomMeta_m && (saveRoomMeta_m.onclick = ()=> { saveRoomMetaAll(); closeRoomsOverlay(); });

async function saveRoomMetaAll(){
  if(!currentRoom) return;

  const name = (roomNameInput_m?.value || roomNameInput?.value || '').trim().slice(0,60);
  const avatar = (roomAvatarInput_m?.value || roomAvatarInput?.value || '').trim();

  try{
    await setDoc(doc(db,'rooms',currentRoom), { name: name || null, avatar: avatar || '' }, { merge: true });
    const idx = myRooms.findIndex(r => r.code === currentRoom);
    if(idx > -1){
      myRooms[idx].name = name || myRooms[idx].name;
      myRooms[idx].avatar = avatar;
      persistMyRooms();
      renderRoomsList();
      updateRoomHeader(myRooms[idx]);
    }
  }catch(e){
    console.error('saveRoomMetaAll error', e);
    alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å');
  }
}

/* ============================== Nickname ============================== */
function renderMessagesQuickMeta(){ /* –∑–∞—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–æ –ø–æ–¥ –±—ã—Å—Ç—Ä—ã–µ –∞–ø–¥–µ–π—Ç—ã –Ω–∏–∫–Ω–µ–π–º–∞ –≤ UI */ }

function saveNick(){
  const isMobile = window.innerWidth < 1000;
  let newNickname = '';
  if (isMobile) {
    if (nicknameInputMobile && nicknameInputMobile.value.trim()) newNickname = nicknameInputMobile.value.trim();
    else if (nicknameInput && nicknameInput.value.trim()) newNickname = nicknameInput.value.trim();
    else newNickname = '–ì–æ—Å—Ç—å';
  } else {
    if (nicknameInput && nicknameInput.value.trim()) newNickname = nicknameInput.value.trim();
    else if (nicknameInputMobile && nicknameInputMobile.value.trim()) newNickname = nicknameInputMobile.value.trim();
    else newNickname = '–ì–æ—Å—Ç—å';
  }
  nickname = newNickname.slice(0,32);
  if (nicknameInput) nicknameInput.value = nickname;
  if (nicknameInputMobile) nicknameInputMobile.value = nickname;
  localStorage.setItem('crm_nick', nickname);
  renderMessagesQuickMeta();
}
if (saveNickBtn) saveNickBtn.addEventListener('click', saveNick);
if (saveNickBtnMobile) saveNickBtnMobile.addEventListener('click', () => { saveNick(); closeRoomsOverlay(); });
if (nicknameInput) nicknameInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); saveNick(); }});
if (nicknameInputMobile) nicknameInputMobile.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); saveNick(); closeRoomsOverlay(); }});

/* ============================== Join UI ============================== */
document.getElementById('btnHome')?.addEventListener('click', ()=> renderRoomsList());
document.getElementById('btnCreate')?.addEventListener('click', ()=> createRoomFlow());
document.getElementById('btnSettings')?.addEventListener('click', ()=> openRoomsOverlay());
createBtn && (createBtn.onclick = ()=> createRoomFlow());
createBtnMobile && (createBtnMobile.onclick = ()=> { createRoomFlow(); closeRoomsOverlay(); });

async function tryJoinFromInput(inputEl){
  const raw = (inputEl?.value || '').trim().toUpperCase();
  if(!raw){ alert('–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –∫–æ–º–Ω–∞—Ç–∞'); return; }
  if(!isValidRoomCode(raw)){ alert('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –∫–æ–¥–∞. –ö–æ–¥ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å 6 —Å–∏–º–≤–æ–ª–æ–≤ A‚ÄìZ (–±–µ–∑ I,L,O) –∏ —Ü–∏—Ñ—Ä 2‚Äì9.'); return; }
  if(!auth.currentUser){
    alert('–í—ã –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, –≤–∫–ª—é—á—ë–Ω Anonymous auth –≤ Firebase Console.');
    return;
  }
  await joinRoomByCode(raw);
}
const joinBtnDesktop = document.getElementById('joinBtn');
if (joinBtnDesktop) joinBtnDesktop.addEventListener('click', ()=> tryJoinFromInput(document.getElementById('joinCode')));

let joinBtnMobileEl = document.getElementById('joinBtn_mobile');
if (!joinBtnMobileEl) {
  const parent = document.getElementById('joinCode_mobile')?.closest('.field') || document.getElementById('joinCode_mobile')?.parentElement;
  joinBtnMobileEl = parent ? parent.querySelector('button') : null;
}
if (joinBtnMobileEl) joinBtnMobileEl.addEventListener('click', ()=> { tryJoinFromInput(document.getElementById('joinCode_mobile')); closeRoomsOverlay(); });

document.getElementById('joinCode')?.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); tryJoinFromInput(e.target); }});
document.getElementById('joinCode_mobile')?.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); tryJoinFromInput(e.target); closeRoomsOverlay(); }});

/* ============================== Auth ============================== */
onAuthStateChanged(auth, async (u) => {
  try {
    if (!u) {
      try {
        const res = await signInAnonymously(auth);
        console.log('signed in anonymously', res?.user?.uid);
      } catch(authErr){
        console.error('signInAnonymously error', authErr);
        alert('–ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å –∞–Ω–æ–Ω–∏–º–Ω—ã–π –≤—Ö–æ–¥. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Authentication –≤ Firebase Console (–≤–∫–ª—é—á–µ–Ω –ª–∏ Anonymous?).');
      }
      return;
    }
    user = u;
    if (nicknameInput) nicknameInput.value = nickname;
    if (nicknameInputMobile) nicknameInputMobile.value = nickname;
    renderRoomsList();
    loadMyRoomsFromFirestore().catch(err => console.error('loadMyRoomsFromFirestore error', err));
  } catch (err) {
    console.error('Auth flow error', err);
    alert('–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏: ' + (err.message || err.code || 'unknown'));
  }
});

/* ============================== Boot ============================== */
saveNick();
renderRoomsList();
window.addEventListener('beforeunload', ()=>{
  stopAllWatchers();
  if(unsubMessages) try{ unsubMessages(); }catch(e){ console.error(e) }
});
// showReplyPanel(messageId, previewText, authorName, avatarUrl)
// - messageId: id —Å–æ–æ–±—â–µ–Ω–∏—è –≤ DOM / Firestore
// - previewText: –∫–æ—Ä–æ—Ç–∫–∏–π —Å–Ω–∏–ø–ø–µ—Ç (—Å—Ç—Ä–æ–∫–∞)
// - authorName: –∏–º—è –∞–≤—Ç–æ—Ä–∞ (—Å—Ç—Ä–æ–∫–∞)
// - avatarUrl: (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) —Å—Å—ã–ª–∫–∞ –Ω–∞ –∞–≤–∞—Ç–∞—Ä, –µ—Å–ª–∏ –Ω–µ—Ç ‚Äî –ø–æ–¥—Å—Ç–∞–≤–∏—Ç –ø–µ—Ä–≤—ã–µ –±—É–∫–≤—ã
function showReplyPanel(messageId, previewText = '', authorName = '–°–æ–æ–±—â–µ–Ω–∏–µ', avatarUrl = '') {
  // –Ω–∞–π–¥–µ–º –∏–ª–∏ —Å–æ–∑–¥–∞–¥–∏–º replyBar
  let rb = document.getElementById('replyBar');
  if(!rb) {
    // –µ—Å–ª–∏ –ø–∞–Ω–µ–ª—å –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç ‚Äî —Å–æ–∑–¥–∞—ë–º –º–∏–Ω–∏–º–∞–ª—å–Ω—É—é (–≤—Å—Ç–∞–≤–ª—è–µ–º –≤ .chat-input-container)
    const container = document.querySelector('.chat-input-container') || document.querySelector('.composer') || document.body;
    rb = document.createElement('div');
    rb.id = 'replyBar';
    rb.className = 'reply-bar';
    rb.innerHTML = `
      <div class="reply-left">
        <div id="replyAvatar" class="reply-avatar"></div>
        <div class="reply-content">
          <div id="replyAuthor" class="reply-author"></div>
          <div id="replySnippet" class="reply-snippet"></div>
        </div>
      </div>
      <button id="cancelReply" class="reply-cancel" aria-label="–û—Ç–º–µ–Ω–∏—Ç—å –æ—Ç–≤–µ—Ç">‚úï</button>
    `;
    container.insertBefore(rb, container.firstChild);
  }

  // —ç–ª–µ–º–µ–Ω—Ç—ã –≤–Ω—É—Ç—Ä–∏
  const aEl = document.getElementById('replyAvatar');
  const auEl = document.getElementById('replyAuthor');
  const snEl = document.getElementById('replySnippet');
  const cancelBtn = document.getElementById('cancelReply');

  // –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ
  if(auEl) auEl.textContent = String(authorName || '–°–æ–æ–±—â–µ–Ω–∏–µ');
  if(snEl) snEl.textContent = String(previewText || '').slice(0,200);
  if(aEl) {
    if(avatarUrl){
      aEl.style.backgroundImage = `url("${avatarUrl}")`;
      aEl.style.backgroundSize = 'cover';
      aEl.textContent = '';
    } else {
      // –ø–µ—Ä–≤—ã–µ 1-2 –±—É–∫–≤—ã
      const initials = (authorName || '').trim().split(/\s+/).map(s=>s[0]).slice(0,2).join('').toUpperCase() || '?';
      aEl.style.backgroundImage = '';
      aEl.textContent = initials;
    }
  }

  // show
  rb.classList.remove('hidden');
  rb.setAttribute('aria-hidden','false');

  // bind cancel if not bound
  if(cancelBtn && !cancelBtn._bound) {
    cancelBtn.addEventListener('click', () => {
      hideReplyPanel();
    });
    cancelBtn._bound = true;
  }

  // –∫–ª–∏–∫ –ø–æ –ø—Ä–µ–≤—å—é ‚Äî —Å–∫—Ä–æ–ª–ª –∫ —Å–æ–æ–±—â–µ–Ω–∏—é
  if(rb._boundClick !== messageId) {
    rb.onclick = (e) => {
      // –µ—Å–ª–∏ –∫–ª–∏–∫ –ø–æ –∫–Ω–æ–ø–∫–µ ‚Äî –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º
      if(e.target.closest('#cancelReply')) return;
      if(messageId) {
        const target = document.querySelector(`.bubble.message[data-id="${CSS.escape(messageId)}"]`);
        if(target) {
          target.scrollIntoView({ behavior: 'smooth', block: 'center' });
          target.classList.add('ping');
          setTimeout(()=> target.classList.remove('ping'), 1200);
        }
      }
    };
    rb._boundClick = messageId;
  }

  // —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≥–ª–æ–±–∞–ª—å–Ω—É—é replyTarget (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è sendText)
  replyTarget = messageId;

  // –ø–æ—Å—Ç–∞–≤–∏—Ç—å —Ñ–æ–∫—É—Å –≤ –∏–Ω–ø—É—Ç
  if(msgInput) msgInput.focus();
}

// hideReplyPanel() ‚Äî —É–±—Ä–∞—Ç—å –ø–∞–Ω–µ–ª—å –∏ —Å–±—Ä–æ—Å–∏—Ç—å replyTarget
function hideReplyPanel() {
  const rb = document.getElementById('replyBar');
  if(rb) {
    rb.classList.add('hidden');
    rb.setAttribute('aria-hidden','true');
  }
  replyTarget = null;
}

</script>


</body>
</html>